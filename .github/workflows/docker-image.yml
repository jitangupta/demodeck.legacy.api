# Builds your existing Dockerfile (Windows/.NET Framework 4.8) on-demand (manual trigger)
# NOTE:
#  - Runs on GitHub-hosted Windows runner with Docker for Windows containers.
#  - Update SOLUTION_PATH and PROJECT_PATH to match your repository.
#  - Pushes to GitHub Container Registry (GHCR) using GITHUB_TOKEN.
name: Manual build and push Windows container

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag (default: commit SHA)'
        required: false
        default: ''

permissions:
  contents: read
  packages: write

env:
  # TODO: update these to your actual solution/project paths
  SOLUTION_PATH: 'YourSolution.sln'
  PROJECT_PATH: 'Path/To/YourWebProject.csproj'
  PUBLISH_DIR: 'bin'   # Your Dockerfile copies ./bin/, so publish to bin/
  IMAGE_REPO: ghcr.io/${{ github.repository }}

jobs:
  build-and-push:
    runs-on: windows-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Restore NuGet packages
        shell: pwsh
        run: |
          Write-Host "Restoring NuGet packages for $env:SOLUTION_PATH"
          nuget restore "${{ env.SOLUTION_PATH }}"

      - name: Build solution (Release)
        shell: pwsh
        run: |
          Write-Host "Building solution $env:SOLUTION_PATH (Release)"
          msbuild "${{ env.SOLUTION_PATH }}" /p:Configuration=Release

      - name: Publish project output to PUBLISH_DIR
        shell: pwsh
        run: |
          $publishDir = Join-Path $PWD "${{ env.PUBLISH_DIR }}"
          if (Test-Path $publishDir) { Remove-Item -Recurse -Force $publishDir }
          New-Item -ItemType Directory -Path $publishDir | Out-Null
          Write-Host "Publishing project $env:PROJECT_PATH to $publishDir"
          msbuild "${{ env.PROJECT_PATH }}" /p:Configuration=Release /p:OutDir="$publishDir\\"
          Write-Host "Publish completed. Files:"
          Get-ChildItem -Recurse $publishDir | Select-Object FullName, Length | ForEach-Object { Write-Host "$($_.FullName) ($($_.Length) bytes)" }

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set image tag
        id: tag
        shell: pwsh
        run: |
          $tag = "${{ github.event.inputs.image_tag }}"
          if ([string]::IsNullOrEmpty($tag)) {
            $tag = "${{ github.sha }}"
          }
          echo "IMAGE_TAG=$tag" >> $env:GITHUB_OUTPUT

      - name: Build Windows Docker image
        shell: pwsh
        env:
          IMAGE: ${{ env.IMAGE_REPO }}:${{ steps.tag.outputs.IMAGE_TAG }}
        run: |
          Write-Host "Building Windows image: $env:IMAGE"
          docker build -f Dockerfile -t $env:IMAGE --build-arg PUBLISH_DIR=${{ env.PUBLISH_DIR }} .

      - name: Push Docker image
        shell: pwsh
        env:
          IMAGE: ${{ env.IMAGE_REPO }}:${{ steps.tag.outputs.IMAGE_TAG }}
        run: |
          Write-Host "Pushing image: $env:IMAGE"
          docker push $env:IMAGE

      - name: Output image
        run: echo "Image pushed: ${{ env.IMAGE_REPO }}:${{ steps.tag.outputs.IMAGE_TAG }}"